/*
  Robotics Project
  CS375:  Computer Systems
  By:     Kyle Aure and Almedin Bajramovic
  Date:   11/24/2018
*/
/* ******Constants****** */
#define THRESHOLD 60
#define FULL_SPEED 75
#define ROTATE_SPEED 50
#define ROTATE_WAIT 300

/* ******Variables****** */
dseg segment
  TouchStatus sword 0  //Bool has touch sensor been activated?
  ClapCount sword 0    //Number of claps sensor has heard?
  ClapStatus sword 0   //Has correct number of claps been heard?
dseg ends

/* *********Thread*******
   Main program - starts all other threads
   ********************* */
thread main
   precedes Move_Around, Clap
endt

/* *********Thread*******
   THREAD: Move_Around
   SENSORS: IN_1 = Touch
   MOTORS: OUT_B, OUT_C
   ********************* */
thread Move_Around
   SetSensorTouch(IN_1)               //Set up Sensors
   SetSensorMode(IN_1,IN_MODE_BOOLEAN)
Resume:                               //Loop here after rotate
   ResetSensor(IN_1)                  //     Reset sensor
   OnFwd(OUT_BC,FULL_SPEED)           //     Go forward
CheckSensor:                          //Loop here continue to check
   ReadSensor(IN_1,TouchStatus)       //     Get sensor status
   brtst NEQ, END, ClapStatus          //If   clap has been sensed END this thread.
                                      //Else continue
   brtst EQ, CheckSensor, TouchStatus //If   sensor was not touched check again
   Off(OUT_BC)                        //Else turn off motors
   call rotate                        //     Rotate
   jmp Resume                         //     Go forward again
END:
    Off(OUT_BC)
    exitto Sound
endt                                  //END THREAD

/* *****Subroutine**** */
subroutine rotate
  //C - Rev, B - Fwd
  OnRev(OUT_C,ROTATE_SPEED)
  OnFwd(OUT_B,ROTATE_SPEED)
  wait ROTATE_WAIT
  //Turn off motors
  Off(OUT_BC)
  return
ends

/* *********Thread*******
   THREAD: Clap
   SENSORS: IN_2 = Sound
   MOTORS: NONE
   ********************* */
thread Clap
  SetSensorType(IN_2, IN_TYPE_SOUND_DB)      //Set up sensors
  SetSensorMode(IN_2, IN_MODE_PERIODCOUNTER)
  ResetSensor(IN_2)
CheckCount:
  ClearSensor(IN_2)                                  //Loop here continue to check
  ReadSensor(IN_2, ClapCount)                //Read sensor for number of claps
  brtst EQ, CheckCount, ClapCount
  wait 500
  brcmp EQ, END, ClapCount, 1
  jmp CheckCount
END:
  set ClapStatus 1                           //ELSE Set ClapStatus = True
endt                                         //END TREAD

/* *********Thread*******

   ********************* */
 thread Sound
 PlayTone(TONE_D5,500)
 wait 500
 endt
